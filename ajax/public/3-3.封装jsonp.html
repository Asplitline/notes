<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <button id='btn1'>jsonp</button>
    <button id='btn2'>jsonp</button>
    <script>
        var btn1 = document.getElementById('btn1');
        var btn2 = document.getElementById('btn2');
        btn1.onclick = function () {
            jsonp({
                url: 'http://localhost:3001/test',
                data: {
                    name: 'zhangsan',
                    age: 19
                },
                success: function (data) {
                    console.log('333')
                    console.log(data);
                }
            })
        }
        btn2.onclick = function () {
            jsonp({
                url: 'http://localhost:3001/test',
                success: function (data) {
                    console.log('444')
                    console.log(data);
                }
            })
        }

        // 服务器端设置1s延迟会导致，btn2会覆盖btn1请求
        // 需要使用随机函数名
        function jsonp(options) {
            var script = document.createElement('script');
            var fName = 'Jsonp' + Math.random().toString().replace('.', '');
            // success不是全局函数，并且是匿名函数
            window[fName] = options.success;
            var params = '';
            for (attr in options.data) {
                params += '&' + attr + '=' + options.data[attr];
            }
            script.src = options.url + '?callback=' + fName + params;
            document.body.appendChild(script);
            script.onload = function () {
                document.body.removeChild(script);
            }
        }


    </script>
</body>

</html>